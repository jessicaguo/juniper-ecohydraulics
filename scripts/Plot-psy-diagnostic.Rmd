---
title: "Diagnostic plots of cleaned psy timeseries"
author: "Jessica Guo"
date: "12/29/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(plantecophys)
library(RColorBrewer)
source("../source/round.POSIXct.R")
```

## Exploring psychrometer time series

After visually inspecting and cleaning the half-hourly time series of *Juniperus osteosperma* stem water potentials, we turn to exploratory plots that will help understand how the trees and loggers relate to each other, to meteorological variables, and in diurnal patterns. 

First, we bring in the relevant datasets, including manual validation of leaf water potential using a pressure chamber. 

```{r, message=FALSE, warning=FALSE}
# Psychrometer (cleaned)
psy <- read_csv(file = "../data_cleaned/psy_hourly.csv",
                locale = locale(tz = "America/Denver")) %>%
  mutate(Tree = as.factor(Tree),
         Logger = as.factor(Logger))

# Manual validation data
man <- read_csv("../data_raw/Pressure-chamber-data.csv") %>%
  rename(dt = 1,
         WP_bar = 4,
         WP_mpa = 5,
         Psy = 6) %>%
  mutate(Tree = as.factor(Tree),
         Logger = as.factor(Logger),
         dt_orig = as.POSIXct(dt, format = "%m/%d/%Y %H:%M", tz = "America/Denver"),
         dt = round.POSIXct(dt_orig, units = "30 mins")) %>%
  select(Tree, Logger, dt, WP_mpa) %>%
  filter(!is.na(WP_mpa))

# Met data
col_names <- names(read_csv("../data_raw/Other-tower-data.csv",
                skip = 1, n_max = 0))

met <- read_csv("../data_raw/Other-tower-data.csv",
                skip = 4, 
                col_names = col_names, 
                na = c("-9999")) %>%
  mutate(dt = as.POSIXct(TIMESTAMP, format = "%m/%d/%Y %H:%M", 
                         tz = "America/Denver"),
         VPD_Avg = RHtoVPD(RH_Avg, AirTemp_Avg)) %>%
  select(dt, AirTemp_Avg, RH_Avg, VPD_Avg, 
         Precip_Tot, contains("VWC")) %>%
  filter(dt >= min(psy$dt) & dt <= max(psy$dt))

# Combine psy and manual and met, create time indices for plotting
psy_met <- psy %>%
  left_join(man) %>%
  left_join( met) %>%
  mutate(month = factor(month.name[lubridate::month(dt)],
                        levels = month.name),
         day = lubridate::day(dt),
         hour = lubridate::hour(dt),
         mo = sprintf("%02d", lubridate::month(dt)),
         Month = as.POSIXct(paste0("2021-", mo, "-01 00:00:00"), 
                            tz = "America/Denver"),
         month_diff = as.numeric(difftime(dt, Month, "secs")),
         month_ind = as.POSIXct(month_diff, 
                                origin = "1970-01-01",
                                tz = "America/Denver")) %>%
  select(-mo, -Month, -month_diff)
```

### Plot all psychrometers together

After separately plotting each tree, we bring together all loggers together to see patterns across the seven individual trees

```{r, echo=FALSE, fig.width=10, fig.height=4}
ggplot() +
  geom_point(data = psy_met, aes(x = dt, y = psy, color = Tree, shape = Logger)) +
  geom_point(data = met, aes(x = dt, y = VWC_5cm_Avg/2)) +
  scale_y_continuous(expression(paste(Psi, " (MPa)")), 
                     sec.axis = sec_axis(~.*2, 
                                         expression(paste(VWC[5*cm], " (", cm^3, " ", cm^-3, ")")))) +
  theme_bw(base_size = 12) +
  theme(axis.title.x = element_blank())
```

### Examine relationship between met variables

```{r, echo=FALSE, warning=FALSE, fig.width=6, fig.height=4}
labs <- pretty(met$dt, 5)
ggplot(met, aes(x = VPD_Avg, y = VWC_10cm_Avg, color = dt)) + 
  geom_point() +
  scale_x_continuous("VPD (kPa)") +
  scale_y_continuous(expression(paste(VWC[5*cm], " (", cm^3, " ", cm^-3, ")"))) +
  scale_color_gradient(low = "goldenrod1", high = "darkorchid",
                       breaks = labs,
                       labels = format(labs, "%b")) +
  theme_bw(base_size = 12)
```

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=4}
ggplot(met, aes(x = dt)) + 
  geom_point(aes(y = VWC_5cm_Avg, color = "5 cm")) +
  geom_point(aes(y = VWC_10cm_Avg, color = "10 cm")) +
  geom_point(aes(y = VWC_20cm_Avg, color = "20 cm")) +
  geom_point(aes(y = VWC_50cm_Avg, color = "50 cm")) +
  geom_point(aes(y = VWC_100cm_Avg, color = "100 cm")) +
  scale_color_manual(values = rev(brewer.pal(6, "BrBG"))[1:5],
                     breaks = c("5 cm",
                                "10 cm",
                                "20 cm", 
                                "50 cm",
                                "100 cm")) +
  theme_bw(base_size = 12)

```

### Examine each tree with met variables

For each tree, plot stem water potential against soil moisture and VPD by month.The color axis indicates day within each month.  

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=6}
psy_met %>%
  ggplot(aes(x = VWC_5cm_Avg, y = psy, shape = Logger, color = day)) +
  geom_point() +
  facet_grid(rows = vars(Tree),
             cols = vars(month)) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous(expression(paste(VWC[5*cm], " (", cm^3, " ", cm^-3, ")"))) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank())

```

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=6}
psy_met %>%
  ggplot(aes(x = VWC_10cm_Avg, y = psy, shape = Logger, color = day)) +
  geom_point() +
  facet_grid(rows = vars(Tree),
             cols = vars(month)) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous(expression(paste(VWC[10*cm], " (", cm^3, " ", cm^-3, ")"))) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank())
```

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=6}

psy_met %>%
  ggplot(aes(x = VPD_Avg, y = psy, shape = Logger, color = day)) +
  geom_point() +
  facet_grid(rows = vars(Tree),
             cols = vars(month)) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous("VPD (kPa)") +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank())
```

The presence of multiple relationships within each panel indicates that the effect of environmental drivers could be interactive and dependent on past conditions. 

### Plot diurnal patterns

Within each month, plot the diurnal patterns of stem water potential. Plots are separated for each tree to better check for differences between loggers. 

```{r, echo=FALSE, warning=FALSE, fig.width=6, fig.height=8}
psy_met %>%
  filter(Tree == 1) %>%
  ggplot(aes(x = hour, y = psy, color = day)) +
  geom_point() +
  facet_grid(cols = vars(Logger),
             rows = vars(month),
             scales = "free_y") +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous("Hour of day", breaks = c(0, 6, 12, 18, 24)) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()) +
  ggtitle("Tree 1")
```

```{r, echo=FALSE, warning=FALSE, fig.width=6, fig.height=8}
psy_met %>%
  filter(Tree == 2) %>%
  ggplot(aes(x = hour, y = psy, color = day)) +
  geom_point() +
  facet_grid(cols = vars(Logger),
             rows = vars(month),
             scales = "free_y") +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous("Hour of day", breaks = c(0, 6, 12, 18, 24)) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()) +
  ggtitle("Tree 2")
```

```{r, echo=FALSE, warning=FALSE, fig.width=6, fig.height=8}
psy_met %>%
  filter(Tree == 3) %>%
  ggplot(aes(x = hour, y = psy, color = day)) +
  geom_point() +
  facet_grid(cols = vars(Logger),
             rows = vars(month),
             scales = "free_y") +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous("Hour of day", breaks = c(0, 6, 12, 18, 24)) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()) +
  ggtitle("Tree 3")
```

```{r, echo=FALSE, warning=FALSE, fig.width=6, fig.height=8}
psy_met %>%
  filter(Tree == 4) %>%
  ggplot(aes(x = hour, y = psy, color = day)) +
  geom_point() +
  facet_grid(cols = vars(Logger),
             rows = vars(month),
             scales = "free_y") +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous("Hour of day", breaks = c(0, 6, 12, 18, 24)) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()) +
  ggtitle("Tree 4")
```

```{r, echo=FALSE, warning=FALSE, fig.width=6, fig.height=8}
psy_met %>%
  filter(Tree == 5) %>%
  ggplot(aes(x = hour, y = psy, color = day)) +
  geom_point() +
  facet_grid(cols = vars(Logger),
             rows = vars(month),
             scales = "free_y") +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous("Hour of day", breaks = c(0, 6, 12, 18, 24)) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()) +
  ggtitle("Tree 5")
```

```{r, echo=FALSE, warning=FALSE, fig.width=6, fig.height=8}
psy_met %>%
  filter(Tree == 6) %>%
  ggplot(aes(x = hour, y = psy, color = day)) +
  geom_point() +
  facet_grid(cols = vars(Logger),
             rows = vars(month),
             scales = "free_y") +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous("Hour of day", breaks = c(0, 6, 12, 18, 24)) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()) +
  ggtitle("Tree 6")
```

```{r, echo=FALSE, warning=FALSE, fig.width=6, fig.height=8}
psy_met %>%
  filter(Tree == 7) %>%
  ggplot(aes(x = hour, y = psy, color = day)) +
  geom_point() +
  facet_grid(cols = vars(Logger),
             rows = vars(month),
             scales = "free_y") +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous("Hour of day", breaks = c(0, 6, 12, 18, 24)) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()) +
  ggtitle("Tree 7")
```

### Time series by month

Finally, the time series for each tree is broken down by month. 

```{r, echo=FALSE, warning=FALSE, fig.width=8, fig.height=10}
psy_met %>%
  filter(month == "May") %>%
  ggplot(aes(x = month_ind)) +
  geom_point(aes(y = psy, color = Logger)) +
  geom_point(aes(y = WP_mpa, color = "manual"),
             size = 2,
             pch = 8) +
  facet_wrap(~Tree, 
             ncol = 1) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_datetime(date_breaks = "1 week", 
                   date_labels = format("%d")) +
  scale_color_manual(values = c("steelblue", "turquoise", "orchid")) +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(shape = c(16, 16, 8)))) +
  ggtitle("May")
```

```{r, echo=FALSE, warning=FALSE, fig.width=8, fig.height=10}
psy_met %>%
  filter(month == "June") %>%
  ggplot(aes(x = month_ind)) +
  geom_point(aes(y = psy, color = Logger)) +
  geom_point(aes(y = WP_mpa, color = "manual"),
             size = 2,
             pch = 8) +
  facet_wrap(~Tree,
             ncol = 1) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_datetime(date_breaks = "1 week", 
                   date_labels = format("%d")) +
  scale_color_manual(values = c("steelblue", "turquoise", "orchid")) +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("June")
```

```{r, echo=FALSE, warning=FALSE, fig.width=8, fig.height=10}
psy_met %>%
  filter(month == "July") %>%
  ggplot(aes(x = month_ind)) +
  geom_point(aes(y = psy, color = Logger)) +
  geom_point(aes(y = WP_mpa, color = "manual"),
             size = 2,
             pch = 8) +
  facet_wrap(~Tree, 
             ncol = 1) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_datetime(date_breaks = "1 week", 
                   date_labels = format("%d")) +
  scale_color_manual(values = c("steelblue", "turquoise", "orchid")) +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("July")
```

```{r, echo=FALSE, warning=FALSE, fig.width=8, fig.height=10}
psy_met %>%
  filter(month == "August") %>%
  ggplot(aes(x = month_ind)) +
  geom_point(aes(y = psy, color = Logger)) +
  geom_point(aes(y = WP_mpa, color = "manual"),
             size = 2,
             pch = 8) +
  facet_wrap(~Tree,
             ncol = 1) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_datetime(date_breaks = "1 week", 
                   date_labels = format("%d")) +
  scale_color_manual(values = c("steelblue", "turquoise", "orchid")) +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("August")
```

```{r, echo=FALSE, warning=FALSE, fig.width=8, fig.height=10}
psy_met %>%
  filter(month == "September") %>%
  ggplot(aes(x = month_ind)) +
  geom_point(aes(y = psy, color = Logger)) +
  geom_point(aes(y = WP_mpa, color = "manual"),
             size = 2,
             pch = 8) +
  facet_wrap(~Tree,
             ncol = 1) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_datetime(date_breaks = "1 week", 
                   date_labels = format("%d")) +
  scale_color_manual(values = c("steelblue", "turquoise", "orchid")) +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("September")
```

```{r, echo=FALSE, warning=FALSE, fig.width=8, fig.height=10}
psy_met %>%
  filter(month == "October") %>%
  ggplot(aes(x = month_ind)) +
  geom_point(aes(y = psy, color = Logger)) +
  geom_point(aes(y = WP_mpa, color = "manual"),
             size = 2,
             pch = 8) +
  facet_wrap(~Tree,
             ncol = 1) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_datetime(date_breaks = "1 week", 
                   date_labels = format("%d")) +
  scale_color_manual(values = c("steelblue", "turquoise", "orchid")) +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("October")
```

```{r, echo=FALSE, warning=FALSE, fig.width=8, fig.height=10}
psy_met %>%
  filter(month == "November") %>%
  ggplot(aes(x = month_ind)) +
  geom_point(aes(y = psy, color = Logger)) +
  geom_point(aes(y = WP_mpa, color = "manual"),
             size = 2,
             pch = 8) +
  facet_wrap(~Tree,
             ncol = 1) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_datetime(date_breaks = "1 week", 
                   date_labels = format("%d")) +
  scale_color_manual(values = c("steelblue", "turquoise", "orchid")) +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_blank()) +
  ggtitle("November")
```