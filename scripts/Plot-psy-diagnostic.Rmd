---
title: "Diagnostic plots of cleaned psy timeseries"
author: "Jessica Guo"
date: "12/29/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plantecophys)
library(RColorBrewer)
```

## Exploring psychrometer time series

After visually inspecting and cleaning the half-hourly time series of *Juniperus osteosperma* stem water potentials, we turn to exploratory plots that will help understand how the trees and loggers relate to each other, to meteorological variables, and in diurnal patterns. 

First, we bring in the relevant datasets. 

```{r, message=FALSE, warning=FALSE}
# Psychrometer (cleaned)
psy <- read_csv(file = "../data_cleaned/psy_hourly.csv") %>%
  mutate(Tree = as.factor(Tree),
         Logger = as.factor(Logger))

# Met data
col_names <- names(read_csv("../data_raw/Other-tower-data.csv",
                skip = 1, n_max = 0))

met <- read_csv("../data_raw/Other-tower-data.csv",
                skip = 4, 
                col_names = col_names, 
                na = c("-9999")) %>%
  mutate(dt = as.POSIXct(TIMESTAMP, format = "%m/%d/%Y %H:%M", 
                         tz = "America/Denver"),
         VPD_Avg = RHtoVPD(RH_Avg, AirTemp_Avg)) %>%
  select(dt, AirTemp_Avg, RH_Avg, VPD_Avg, 
         Precip_Tot, contains("VWC")) %>%
  filter(dt >= min(psy$dt) & dt <= max(psy$dt))

# Combine
psy_met <- left_join(psy, met) %>%
  mutate(month = factor(month.name[lubridate::month(dt)],
                        levels = month.name),
         day = lubridate::day(dt))

```

### Plot all psychrometers together

After separately plotting each tree, we bring together all loggers together to see patterns across the seven individual trees

```{r, echo=FALSE, fig.width=10, fig.height=4}
ggplot() +
  geom_point(data = psy_met, aes(x = dt, y = psy, color = Tree, shape = Logger)) +
  geom_point(data = met, aes(x = dt, y = VWC_5cm_Avg/2)) +
  scale_y_continuous(expression(paste(Psi, " (MPa)")), 
                     sec.axis = sec_axis(~.*2, 
                                         expression(paste(VWC[5*cm], " (", cm^3, " ", cm^-3, ")")))) +
  theme_bw(base_size = 12) +
  theme(axis.title.x = element_blank())
```

### Examine relationship between met variables

```{r, echo=FALSE, warning=FALSE, fig.width=6, fig.height=4}
labs <- pretty(met$dt, 5)
ggplot(met, aes(x = VPD_Avg, y = VWC_10cm_Avg, color = dt)) + 
  geom_point() +
  scale_x_continuous("VPD (kPa)") +
  scale_y_continuous(expression(paste(VWC[5*cm], " (", cm^3, " ", cm^-3, ")"))) +
  scale_color_gradient(low = "goldenrod1", high = "darkorchid",
                       breaks = labs,
                       labels = format(labs, "%b")) +
  theme_bw(base_size = 12)
```

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=4}
ggplot(met, aes(x = dt)) + 
  geom_point(aes(y = VWC_5cm_Avg, color = "5 cm")) +
  geom_point(aes(y = VWC_10cm_Avg, color = "10 cm")) +
  geom_point(aes(y = VWC_20cm_Avg, color = "20 cm")) +
  geom_point(aes(y = VWC_50cm_Avg, color = "50 cm")) +
  geom_point(aes(y = VWC_100cm_Avg, color = "100 cm")) +
  scale_color_manual(values = rev(brewer.pal(6, "BrBG"))[1:5],
                     breaks = c("5 cm",
                                "10 cm",
                                "20 cm", 
                                "50 cm",
                                "100 cm")) +
  theme_bw(base_size = 12)

```

### Examine each tree with met variables

For each tree, plot stem water potential against soil moisture and VPD by month.The color axis indicates day within eacn month.  

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=6}
psy_met %>%
  ggplot(aes(x = VWC_5cm_Avg, y = psy, shape = Logger, color = day)) +
  geom_point() +
  facet_grid(rows = vars(Tree),
             cols = vars(month)) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous(expression(paste(VWC[5*cm], " (", cm^3, " ", cm^-3, ")"))) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank())

```

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=6}
psy_met %>%
  ggplot(aes(x = VWC_10cm_Avg, y = psy, shape = Logger, color = day)) +
  geom_point() +
  facet_grid(rows = vars(Tree),
             cols = vars(month)) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous(expression(paste(VWC[10*cm], " (", cm^3, " ", cm^-3, ")"))) +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank())
```

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=6}

psy_met %>%
  ggplot(aes(x = VPD_Avg, y = psy, shape = Logger, color = day)) +
  geom_point() +
  facet_grid(rows = vars(Tree),
             cols = vars(month)) +
  scale_y_continuous(expression(paste(Psi, " (MPa)"))) +
  scale_x_continuous("VPD (kPa)") +
  scale_color_gradient(low = "yellow", high = "darkorchid") +
  theme_bw(base_size = 12) +
  theme(panel.grid = element_blank())
```
