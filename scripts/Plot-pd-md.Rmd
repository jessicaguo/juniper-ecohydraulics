---
title: "Summarizing predawn and midday"
author: "Jessica Guo"
date: "11/30/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(xts)
library(dygraphs)
```

## Daily values of predawn and midday plant water potential

The cleaned half-hourly psychrometer values have been summarized to daily predawn (mean of 2 hours prior to sunrise, inclusive) and midday (mean of 2 hours following solar noon, inclusive). Similarly, the half-hourly environmental variables  have been summarized to daily sums or statistics (mean, min, max), depending on the variable. 
```{r, message=FALSE}
load("../data_cleaned/met_daily.Rdata")
load("../data_cleaned/psy_daily.Rdata")
```

Next, we will exclusively consider the predawn and midday means matched with the daily environmental variables. For plotting purposes, we will also include the maintenance times. After each maintenance, the logger was switched to a new, previously un-instrumented branch. Therefore, the identity of Logger 1 and Logger 2 are arbitrary and considered replicates for the same time period.  

```{r, message=FALSE}
met_clip <- met_daily %>%
  filter(date >= min(psy_daily$date),
         date <= max(psy_daily$date))

psy_all <- psy_daily %>%
  select(Tree, Logger, date, type, WP) %>%
  pivot_wider(names_from = type,
              values_from = WP) %>%
  left_join(met_daily, by = "date")

maint <- read_csv("../data_raw/Maintenance-times.csv") %>%
  mutate(st_date = as.Date(Start),
         en_date = as.Date(End))
```

### Plotting daily timeseries

For each tree and logger, we examine how stem water potential varies over time with daily maximum VPD and precipitation. Vertical bars represent maintenance periods. 

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=10}
ggplot() +
  geom_rect(data = maint, 
            aes(xmin = st_date, xmax = en_date, 
                ymin= -Inf, ymax = Inf),
            alpha = 0.5) +
  geom_point(data = psy_all,
             aes(x = date,y = MD, col = "MD (MPa)"),
             size = 2) +
  geom_point(data = psy_all,
             aes(x = date,y = PD, col = "PD (MPa)"),
             size = 2) +
  geom_line(data = met_clip,
            aes(x = date,y = VPD_max, col = "VPD (kPa)"),
            size = 1.5) +
  geom_bar(data = met_clip,
           aes(x = date,y = Precip/10, fill = "Precip"),
           stat = "identity") +
  facet_grid(cols = vars(Logger),
             rows = vars(Tree)) +
  scale_y_continuous(expression(paste(Psi, " | VPD | Precip (cm)"))) +
  theme_bw(base_size = 14) +
  theme(strip.background = element_blank(),
        axis.title.x = element_blank(),
        legend.title = element_blank()) +
  scale_color_manual(values = c("darkkhaki",
                               "aquamarine3",
                               "coral")) +
  scale_fill_manual(values = "cornflowerblue") +
  guides(fill = "none",
         color = guide_legend(
           override.aes = list(linetype = c(0, 0, 1),
                               shape = c(16, 16, NA),
                               size = c(3, 3, 1.5))))
```
