---
title: "Summarizing predawn and midday"
author: "Jessica Guo"
date: "11/30/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(cowplot)
```

## Daily values of predawn and midday plant water potential

The cleaned half-hourly psychrometer values have been summarized to daily predawn (mean of 2 hours prior to sunrise, inclusive) and midday (mean of 2 hours following solar noon, inclusive). Similarly, the half-hourly environmental variables  have been summarized to daily sums or statistics (mean, min, max), depending on the variable. 
```{r, message=FALSE}
load("../data_cleaned/met_daily.Rdata")
load("../data_cleaned/psy_daily.Rdata")
```

Next, we will exclusively consider the predawn and midday means matched with the daily environmental variables. For plotting purposes, we will also include the maintenance times. After each maintenance, the logger was switched to a new, previously un-instrumented branch. Therefore, the identity of Logger 1 and Logger 2 are arbitrary and considered replicates for the same time period.  

```{r, message=FALSE}
met_clip <- met_daily %>%
  filter(date >= min(psy_daily$date),
         date <= max(psy_daily$date))

psy_all <- psy_daily %>%
  select(Tree, Logger, date, type, WP) %>%
  pivot_wider(names_from = type,
              values_from = WP) %>%
  left_join(met_daily, by = "date")

# save(psy_all, file = "../daily_app/psy_all.Rdata")

maint <- read_csv("../data_raw/Maintenance-times.csv") %>%
  mutate(st_date = as.Date(Start),
         en_date = as.Date(End))
 
# save(maint, file = "../daily_app/maint.Rdata")
```

### Plotting daily timeseries

For each tree and logger, we examine how stem water potential varies over time with daily maximum VPD and precipitation. Vertical bars represent maintenance periods. 

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=10}
ggplot() +
  geom_rect(data = maint, 
            aes(xmin = st_date, xmax = en_date, 
                ymin= -Inf, ymax = Inf),
            alpha = 0.5) +
  geom_point(data = psy_all,
             aes(x = date,y = MD, col = "MD (MPa)"),
             size = 2) +
  geom_point(data = psy_all,
             aes(x = date,y = PD, col = "PD (MPa)"),
             size = 2) +
  geom_line(data = met_clip,
            aes(x = date,y = VPD_max, col = "VPD (kPa)"),
            size = 1.5) +
  geom_bar(data = met_clip,
           aes(x = date,y = Precip/10, fill = "Precip"),
           stat = "identity") +
  facet_grid(cols = vars(Logger),
             rows = vars(Tree)) +
  scale_y_continuous(expression(paste(Psi, " | VPD | Precip (cm)"))) +
  theme_bw(base_size = 14) +
  theme(strip.background = element_blank(),
        axis.title.x = element_blank(),
        legend.title = element_blank()) +
  scale_color_manual(values = c("darkkhaki",
                               "aquamarine3",
                               "coral")) +
  scale_fill_manual(values = "cornflowerblue") +
  guides(fill = "none",
         color = guide_legend(
           override.aes = list(linetype = c(0, 0, 1),
                               shape = c(16, 16, NA),
                               size = c(3, 3, 1.5))))
```

Next, plot the predawn and midday water potentials as a time series with soil moisture. 

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=10}
ggplot() +
  geom_rect(data = maint, 
            aes(xmin = st_date, xmax = en_date, 
                ymin= -Inf, ymax = Inf),
            alpha = 0.5) +
  geom_point(data = psy_all,
             aes(x = date,y = MD, col = "MD"),
             size = 2) +
  geom_point(data = psy_all,
             aes(x = date,y = PD, col = "PD"),
             size = 2) +
  geom_bar(data = met_clip,
           aes(x = date,y = Precip/10, fill = "Precip"),
           stat = "identity") +
  geom_line(data = met_clip,
            aes(x = date,y = VWC_5cm/2, col = "VWC (5 cm)"),
            size = 1) +
  geom_line(data = met_clip,
            aes(x = date,y = VWC_10cm/2, col = "VWC (10 cm)"),
            size = 1) +
  geom_line(data = met_clip,
            aes(x = date,y = VWC_20cm/2, col = "VWC (20 cm)"),
            size = 1) +
  scale_y_continuous(expression(paste(Psi, " (MPa) | Precip (cm)")),
                     sec.axis = sec_axis(~.*2, 
                                         name = "VWC (%)")) +
  facet_grid(cols = vars(Logger),
             rows = vars(Tree)) +
  theme_bw(base_size = 14) +
  theme(strip.background = element_rect(fill = "transparent"),
        axis.title.x = element_blank(),
        legend.title = element_blank()) +
  scale_color_manual(values = c("aquamarine3",
                                "darkkhaki",
                                "mistyrose4",
                                "darkgoldenrod",
                                "chocolate4"),
                     breaks = c("PD", "MD",
                                "VWC (5 cm)",
                                "VWC (10 cm)",
                                "VWC (20 cm)")) +
  scale_fill_manual(values = "cornflowerblue") +
  guides(fill = "none",
         color = guide_legend(
           override.aes = list(linetype = c(0, 0, 1, 1, 1),
                               shape = c(16, 16, NA, NA, NA),
                               size = c(3, 3, 1.5, 1.5, 1.5))))
```

## Separating by branch

Because the loggers were rotated to a fresh branch during each maintenance period, the label of Logger 1 and Logger 2 are better expressed as Branches 1 - x. Let us add the Branch label to each set of water potential observations. 

```{r, message=FALSE}
psy_all2 <- psy_all %>%
  mutate(period = case_when(date > maint$en_date[1] &
                              date < maint$st_date[2] ~ 1,
                          date > maint$en_date[2] &
                              date < maint$st_date[3] ~ 2,
                          date > maint$en_date[3] &
                              date < maint$st_date[4] ~ 3,
                          date > maint$en_date[4] &
                              date < maint$st_date[5] ~ 4,
                          date > maint$en_date[5] ~ 5))

branch_id <- psy_all2 %>%
  group_by(Tree, Logger, period) %>%
  count() %>%
  group_by(Logger, period) %>%
  mutate(branch_fixed = cur_group_id()) %>%
  select(-n)

psy_all3 <- psy_all2 %>%
  left_join(branch_id)
```

Next, plot relationships between environmental variables and predawn/midday water potential, with individual branches as separate colors. 

First, the relationship between daily max VPD and stem water potential differs between trees, but also between branches. 

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=5}
fig1a <- ggplot(psy_all3, aes(x = VPD_max, y = PD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[PD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(D[max], " (kPa)"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14) +
  theme(strip.background = element_blank())

fig1b <- ggplot(psy_all3, aes(x = VPD_max, y = MD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[MD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(D[max], " (kPa)"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14)+
  theme(strip.background = element_blank())

plot_grid(fig1a, fig1b,  nrow = 2)

```

Second, the relationship between soil VWC and stem water potential also shows both between tree and between branch differences.

#### 5 cm

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=5}
fig2a <- ggplot(psy_all3, aes(x = VWC_5cm, y = PD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[PD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[5], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14) +
  theme(strip.background = element_blank())

fig2b <- ggplot(psy_all3, aes(x = VWC_5cm, y = MD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[MD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[5], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14)+
  theme(strip.background = element_blank())

plot_grid(fig2a, fig2b,  nrow = 2)
```

#### 10 cm

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=5}

fig3a <- ggplot(psy_all3, aes(x = VWC_10cm, y = PD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[PD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[10], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14) +
  theme(strip.background = element_blank())

fig3b <- ggplot(psy_all3, aes(x = VWC_10cm, y = MD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[MD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[10], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14)+
  theme(strip.background = element_blank())

plot_grid(fig3a, fig3b,  nrow = 2)
```

#### 20 cm

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=5}

fig4a <- ggplot(psy_all3, aes(x = VWC_20cm, y = PD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[PD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[20], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14) +
  theme(strip.background = element_blank())

fig4b <- ggplot(psy_all3, aes(x = VWC_20cm, y = MD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[MD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[20], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14)+
  theme(strip.background = element_blank())

plot_grid(fig4a, fig4b,  nrow = 2)
```

#### 50 cm

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=5}

fig5a <- ggplot(psy_all3, aes(x = VWC_50cm, y = PD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[PD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[50], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14) +
  theme(strip.background = element_blank())

fig5b <- ggplot(psy_all3, aes(x = VWC_50cm, y = MD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[MD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[50], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14)+
  theme(strip.background = element_blank())

plot_grid(fig5a, fig5b,  nrow = 2)
```

#### 100 cm

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=5}

fig6a <- ggplot(psy_all3, aes(x = VWC_100cm, y = PD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[PD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[100], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14) +
  theme(strip.background = element_blank())

fig6b <- ggplot(psy_all3, aes(x = VWC_100cm, y = MD)) +
  geom_point(aes(color = as.factor(branch_fixed))) +
  scale_y_continuous(expression(paste(Psi[MD], " (MPa)")),
                     limits = c(-10, 0),
                     breaks = seq(-9, 0, 3)) +
  scale_x_continuous(expression(paste(Theta[100], " (", m^3, " ", m^-3, ")"))) +
  facet_wrap(~Tree, nrow = 1) +
  guides(color = "none") +
  theme_bw(base_size = 14)+
  theme(strip.background = element_blank())

plot_grid(fig6a, fig6b,  nrow = 2)
```