---
title: "Honing diurnal signal"
author: "Jessica Guo"
date: "2023-02-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(plantecophys)
library(xts)
library(dygraphs)
```

## Refining the diurnal signal

This script further refines the diurnal signal previously cleaned in `Plot-psy-raw.Rmd` with `data_raw/Psy-skip-dates.csv` to produce `data_cleaned/psy_hourly.csv`. Here, I am preparing the dataset for analysis for diurnal patterns, including to assess the 3 am to 7 am time period as reaching equilibrium (asymptotic) or not. Thus, although `psy_hourly.csv` has formed the basis of calculating daily values of predawn and midday, additional scrutiny of the diurnal pattern is desired. Anomalies during the predawn window and/or loss of diurnal signal qualifies for data removal. 

```{r data_in, message=FALSE, warning=FALSE}
psy <- read_csv(file = "../data_cleaned/psy_hourly.csv",
                locale = locale(tz = "America/Denver")) %>%
  mutate(Tree = as.factor(Tree),
         Logger = as.factor(Logger))

col_names <- names(read_csv("../data_raw/Other-tower-data.csv",
                skip = 1, n_max = 0))

met <- read_csv("../data_raw/Other-tower-data.csv",
                skip = 4, 
                col_names = col_names, 
                na = c("-9999")) %>%
  mutate(dt = as.POSIXct(TIMESTAMP, format = "%m/%d/%Y %H:%M", 
                         tz = "America/Denver"),
         VPD_Avg = RHtoVPD(RH_Avg, AirTemp_Avg)) %>%
  select(dt, AirTemp_Avg, RH_Avg, VPD_Avg, 
         Precip_Tot, contains("VWC")) %>%
  filter(dt >= min(psy$dt) & dt <= max(psy$dt))

# Make wide and join together
psy_wide <- psy %>%
  select(Tree, Logger, dt, psy) %>%
  tidyr::pivot_wider(names_from = c(Tree, Logger),
                     values_from = psy) %>%
  left_join(met) %>%
  mutate(date = as.Date(dt, tz = "America/Denver"))
```

## Dynamic plots by tree

Recreate dygraphs with cleaned hourly data and highlight the predawn period of interest (3 am to 7 am). 

```{r predawn-period}
diurnal <- data.frame(date = seq(min(psy_wide$date), max(psy_wide$date), 
                                 by = 'day') %>% 
                        force_tz(tzone = "America/Denver")) %>%
  mutate(predawn_st = as.POSIXct(date, tz = "America/Denver") + 3*60*60,
         predawn_en = as.POSIXct(date, tz = "America/Denver") + 7*60*60)
```

#### Tree 1

```{r, echo=FALSE, fig.width=10, fig.height=3}
tree_1 <- psy_wide %>%
  select(dt, '1_1', '1_2', "VPD_Avg")
tree_1 <- xts(tree_1[,-1], order.by = tree_1$dt)

met_xts <- psy_wide %>%
  select(dt, Precip_Tot, VWC_5cm_Avg, VWC_10cm_Avg)
met_xts <- xts(met_xts[,-1], order.by = met_xts$dt)

dg <- dygraph(tree_1, group = "tree-1") %>%
  dySeries("1_1", color = "seagreen") %>%
  dySeries("1_2", color = "turquoise") %>%
  dySeries("VPD_Avg", color = "darkorange", 
           pointShape = "triangle") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyRangeSelector() %>%
  dyAxis("y", label = "Psi (MPa) | VPD (kPa)") %>% 
  # dyAxis("y2", label = "VPD (kPa)") %>% 
  dyLegend(show = "follow") %>%
  dyRangeSelector(height = 20, strokeColor = "")

for (i in 1:nrow(diurnal)) {
  dg <- dg %>% dyShading(from = diurnal$predawn_st[i], 
                         to = diurnal$predawn_en[i],
                         color = "#CCEBD6")
}
dg

```

#### Tree 2

```{r, echo=FALSE, fig.width=10, fig.height=3}
tree_2 <- psy_wide %>%
  select(dt, '2_1', '2_2', "VPD_Avg")
tree_2 <- xts(tree_2[,-1], order.by = tree_2$dt)

dg <- dygraph(tree_2, group = "tree-2") %>%
  dySeries("2_1", color = "seagreen") %>%
  dySeries("2_2", color = "turquoise") %>%
  dySeries("VPD_Avg", color = "darkorange", 
           pointShape = "triangle") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyRangeSelector() %>%
  dyAxis("y", label = "Psi (MPa) | VPD (kPa)") %>% 
  # dyAxis("y2", label = "VPD (kPa)") %>% 
  dyLegend(show = "follow") %>%
  dyRangeSelector(height = 20, strokeColor = "")

for (i in 1:nrow(diurnal)) {
  dg <- dg %>% dyShading(from = diurnal$predawn_st[i], 
                         to = diurnal$predawn_en[i],
                         color = "#CCEBD6")
}
dg

```

#### Tree 3

```{r, echo=FALSE, fig.width=10, fig.height=3}
tree_3 <- psy_wide %>%
  select(dt, '3_1', '3_2', "VPD_Avg")
tree_3 <- xts(tree_3[,-1], order.by = tree_3$dt)

dg <- dygraph(tree_3, group = "tree-3") %>%
  dySeries("3_1", color = "seagreen") %>%
  dySeries("3_2", color = "turquoise") %>%
  dySeries("VPD_Avg", color = "darkorange", 
           pointShape = "triangle") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyRangeSelector() %>%
  dyAxis("y", label = "Psi (MPa) | VPD (kPa)") %>% 
  # dyAxis("y2", label = "VPD (kPa)") %>% 
  dyLegend(show = "follow") %>%
  dyRangeSelector(height = 20, strokeColor = "")

for (i in 1:nrow(diurnal)) {
  dg <- dg %>% dyShading(from = diurnal$predawn_st[i], 
                         to = diurnal$predawn_en[i],
                         color = "#CCEBD6")
}
dg

```


#### Tree 4

```{r, echo=FALSE, fig.width=10, fig.height=3}
tree_4 <- psy_wide %>%
  select(dt, '4_1', '4_2', "VPD_Avg")
tree_4 <- xts(tree_4[,-1], order.by = tree_4$dt)

dg <- dygraph(tree_4, group = "tree-4") %>%
  dySeries("4_1", color = "seagreen") %>%
  dySeries("4_2", color = "turquoise") %>%
  dySeries("VPD_Avg", color = "darkorange", 
           pointShape = "triangle") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyRangeSelector() %>%
  dyAxis("y", label = "Psi (MPa) | VPD (kPa)") %>% 
  # dyAxis("y2", label = "VPD (kPa)") %>% 
  dyLegend(show = "follow") %>%
  dyRangeSelector(height = 20, strokeColor = "")

for (i in 1:nrow(diurnal)) {
  dg <- dg %>% dyShading(from = diurnal$predawn_st[i], 
                         to = diurnal$predawn_en[i],
                         color = "#CCEBD6")
}
dg

```

#### Tree 5

```{r, echo=FALSE, fig.width=10, fig.height=3}
tree_5 <- psy_wide %>%
  select(dt, '5_1', '5_2', "VPD_Avg")
tree_5 <- xts(tree_5[,-1], order.by = tree_5$dt)

dg <- dygraph(tree_5, group = "tree-5") %>%
  dySeries("5_1", color = "seagreen") %>%
  dySeries("5_2", color = "turquoise") %>%
  dySeries("VPD_Avg", color = "darkorange", 
           pointShape = "triangle") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyRangeSelector() %>%
  dyAxis("y", label = "Psi (MPa) | VPD (kPa)") %>% 
  # dyAxis("y2", label = "VPD (kPa)") %>% 
  dyLegend(show = "follow") %>%
  dyRangeSelector(height = 20, strokeColor = "")

for (i in 1:nrow(diurnal)) {
  dg <- dg %>% dyShading(from = diurnal$predawn_st[i], 
                         to = diurnal$predawn_en[i],
                         color = "#CCEBD6")
}
dg

```


#### Tree 6

```{r, echo=FALSE, fig.width=10, fig.height=3}
tree_6 <- psy_wide %>%
  select(dt, '6_1', '6_2', "VPD_Avg")
tree_6 <- xts(tree_6[,-1], order.by = tree_6$dt)

dg <- dygraph(tree_6, group = "tree-6") %>%
  dySeries("6_1", color = "seagreen") %>%
  dySeries("6_2", color = "turquoise") %>%
  dySeries("VPD_Avg", color = "darkorange", 
           pointShape = "triangle") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyRangeSelector() %>%
  dyAxis("y", label = "Psi (MPa) | VPD (kPa)") %>% 
  # dyAxis("y2", label = "VPD (kPa)") %>% 
  dyLegend(show = "follow") %>%
  dyRangeSelector(height = 20, strokeColor = "")

for (i in 1:nrow(diurnal)) {
  dg <- dg %>% dyShading(from = diurnal$predawn_st[i], 
                         to = diurnal$predawn_en[i],
                         color = "#CCEBD6")
}
dg

```

#### Tree 7

```{r, echo=FALSE, fig.width=10, fig.height=3}
tree_7 <- psy_wide %>%
  select(dt, '7_1', '7_2', "VPD_Avg")
tree_7 <- xts(tree_7[,-1], order.by = tree_7$dt)

dg <- dygraph(tree_7, group = "tree-7") %>%
  dySeries("7_1", color = "seagreen") %>%
  dySeries("7_2", color = "turquoise") %>%
  dySeries("VPD_Avg", color = "darkorange", 
           pointShape = "triangle") %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyRangeSelector() %>%
  dyAxis("y", label = "Psi (MPa) | VPD (kPa)") %>% 
  # dyAxis("y2", label = "VPD (kPa)") %>% 
  dyLegend(show = "follow") %>%
  dyRangeSelector(height = 20, strokeColor = "")

for (i in 1:nrow(diurnal)) {
  dg <- dg %>% dyShading(from = diurnal$predawn_st[i], 
                         to = diurnal$predawn_en[i],
                         color = "#CCEBD6")
}
dg

```